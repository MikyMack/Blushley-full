<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeautyPro | Retailer Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #c9a961;
            --secondary-color: #b89446;
            --accent-color: #e6c98c;
            --light-color: #fefcf7;
            --dark-color: #3a3526;
            --success-color: #175507;
            --warning-color: #972b1f;
            --danger-color: #c97d6a;
            --gray-light: #f5f1e8;
            --gray-medium: #a59e8c;
            --border-radius: 12px;
            --box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #fefcf7;
            color: var(--dark-color);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar Styles */
        .sidebar-navigation {
            width: 260px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 25px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .brand-logo {
            display: flex;
            align-items: center;
            padding: 0 25px 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .brand-logo i {
            font-size: 28px;
            margin-right: 12px;
        }

        .brand-logo h1 {
            font-size: 22px;
            font-weight: 700;
        }

        .nav-menu {
            list-style: none;
            margin-top: 30px;
        }

        .nav-item {
            padding: 14px 25px;
            display: flex;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .nav-item.active {
            background-color:white;
            color: var(--primary-color);
            border-left: 4px solid var(--accent-color);
        }

        .nav-item i {
            font-size: 18px;
            margin-right: 15px;
            width: 24px;
            text-align: center;
        }

        .nav-item span {
            font-weight: 500;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            z-index: 1100;
            font-size: 18px;
            cursor: pointer;
            box-shadow: var(--box-shadow);
        }

        /* Main Content Area */
        .main-content-area {
            flex: 1;
            margin-left: 260px;
            padding: 30px;
            transition: var(--transition);
        }

        .header-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--dark-color);
        }

        .page-title p {
            color: var(--gray-medium);
            margin-top: 5px;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 20px;
            overflow: hidden;
            border: 2px solid var(--accent-color);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-info h4 {
            font-weight: 600;
        }

        .user-info p {
            font-size: 14px;
            color: var(--gray-medium);
        }

        /* Dashboard Cards */
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-light);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .card-icon.primary {
            background-color: rgba(201, 169, 97, 0.15);
            color: var(--primary-color);
        }

        .card-icon.success {
            background-color: rgba(138, 155, 110, 0.15);
            color: var(--success-color);
        }

        .card-icon.warning {
            background-color: rgba(212, 165, 116, 0.15);
            color: var(--warning-color);
        }

        .card-icon.danger {
            background-color: rgba(201, 125, 106, 0.15);
            color: var(--danger-color);
        }

        .card-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .card-label {
            color: var(--gray-medium);
            font-size: 15px;
        }

        /* Dashboard Sections */
        .dashboard-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 30px;
            align-items: start;
        }
        
        /* Section Cards */
        .section-card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
            margin-bottom: 30px;
            border: 1px solid var(--gray-light);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
        }

        .view-all-link {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
        }

        /* Buttons */
        .action-button {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .confirm-button {
            background-color: var(--success-color);
            color: white;
        }

        .confirm-button:hover {
            background-color: #7a8a5f;
        }

        .edit-button {
            background-color: var(--primary-color);
            color: white;
        }

        .edit-button:hover {
            background-color: #b89446;
        }

        .secondary-button {
            background-color: var(--gray-light);
            color: var(--dark-color);
        }

        .secondary-button:hover {
            background-color: #e8e2d3;
        }

        .add-button {
            background-color: var(--success-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .details-button {
            background-color: #560c0c;
            color: white;
        }

        .details-button:hover {
            background-color: #992311;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 15px;
            border-bottom: 1px solid var(--gray-light);
            color: black;
            font-weight: 500;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--gray-light);
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-pending {
            background-color: rgba(212, 165, 116, 0.15);
            color: var(--warning-color);
        }

        .status-confirmed {
            background-color: rgba(138, 155, 110, 0.15);
            color: var(--success-color);
        }

        .status-completed {
            background-color: rgba(201, 169, 97, 0.15);
            color: var(--primary-color);
        }

        .status-cancelled {
            background-color: rgba(201, 125, 106, 0.15);
            color: var(--danger-color);
        }

        /* Table Responsive */
        .table-responsive {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        
        .table-responsive table {
            width: 100%;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--gray-light);
            border-radius: 8px;
            font-size: 15px;
            transition: var(--transition);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(201, 169, 97, 0.1);
        }

        /* Image Upload Styles */
        .image-upload-container {
            margin-bottom: 20px;
        }

        .image-preview {
            width: 150px;
            height: 150px;
            border: 2px dashed var(--gray-medium);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 15px;
            overflow: hidden;
            background-color: var(--gray-light);
        }

        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .image-placeholder {
            text-align: center;
            color: var(--gray-medium);
        }

        .image-placeholder i {
            font-size: 40px;
            margin-bottom: 10px;
            display: block;
        }

        .upload-btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-btn:hover {
            background-color: var(--secondary-color);
        }

        .upload-btn input {
            display: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: white;
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transform: translateY(-20px);
            transition: var(--transition);
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--gray-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: var(--gray-medium);
        }

        .modal-body {
            padding: 25px;
        }

        .modal-footer {
            padding: 20px 25px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* Order Details Styles */
        .order-details-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .client-info-section, .order-items-section {
            background-color: var(--gray-light);
            border-radius: var(--border-radius);
            padding: 20px;
        }

        .section-subtitle {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark-color);
            border-bottom: 1px solid var(--gray-medium);
            padding-bottom: 8px;
        }

        .client-details {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .client-field {
            display: flex;
            justify-content: space-between;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .client-field:last-child {
            border-bottom: none;
        }

        .field-name {
            font-weight: 500;
            color: var(--dark-color);
        }

        .field-value {
            color: var(--gray-medium);
        }

        .order-items {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .order-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .item-image {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            overflow: hidden;
            flex-shrink: 0;
        }

        .item-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .item-details {
            flex: 1;
        }

        .item-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .item-category {
            color: var(--gray-medium);
            font-size: 14px;
            margin-bottom: 5px;
        }

        .item-price {
            font-weight: 600;
            color: var(--primary-color);
        }

        .item-quantity {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-badge {
            background-color: var(--primary-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }

        .order-summary {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid var(--gray-medium);
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .summary-total {
            font-weight: 700;
            font-size: 18px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--gray-medium);
        }

        /* Product Grid */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            background-color: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
            border: 1px solid var(--gray-light);
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }

        .product-image {
            height: 180px;
            background-color: var(--gray-light);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .product-details {
            padding: 15px;
        }

        .product-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .product-category {
            color: var(--gray-medium);
            font-size: 14px;
            margin-bottom: 10px;
        }

        .product-price {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .product-stock {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            color: var(--gray-medium);
        }

        .product-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        /* Enhanced Account Section Styles */
        .profile-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .profile-field {
            display: flex;
            flex-direction: column;
            padding: 15px;
            background-color: var(--gray-light);
            border-radius: 8px;
            transition: var(--transition);
        }

        .profile-field:hover {
            background-color: #f0ebe0;
        }

        .profile-field.editing {
            background-color: white;
            border: 1px solid var(--primary-color);
            box-shadow: 0 2px 8px rgba(201, 169, 97, 0.2);
        }

        .field-label {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .field-value {
            color: var(--gray-medium);
        }

        .profile-field input, .profile-field textarea {
            border: 1px solid var(--gray-medium);
            border-radius: 4px;
            padding: 8px 12px;
            font-size: 15px;
            background-color: white;
            transition: var(--transition);
        }

        .profile-field input:focus, .profile-field textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(201, 169, 97, 0.2);
        }

        .profile-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: flex-end;
        }

        .profile-actions button {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .profile-actions .save-btn {
            background-color: var(--success-color);
            color: white;
        }

        .profile-actions .save-btn:hover {
            background-color: #7a8a5f;
        }

        .profile-actions .cancel-btn {
            background-color: var(--gray-medium);
            color: white;
        }

        .profile-actions .cancel-btn:hover {
            background-color: #8c8268;
        }

        .profile-actions .edit-btn {
            background-color: var(--primary-color);
            color: white;
        }

        .profile-actions .edit-btn:hover {
            background-color: #b89446;
        }

        .profile-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid var(--gray-light);
        }

        .profile-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid var(--accent-color);
            box-shadow: var(--box-shadow);
        }

        .profile-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: var(--dark-color);
        }

        .profile-info p {
            color: var(--gray-medium);
            margin-bottom: 10px;
        }

        .profile-stats {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .profile-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 15px;
            background-color: var(--gray-light);
            border-radius: 8px;
            min-width: 100px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: 700;
            color: var(--primary-color);
        }

        .stat-label {
            font-size: 12px;
            color: var(--gray-medium);
            text-align: center;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .dashboard-sections {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 992px) {
            /* Collapse sidebar fully on tablets and below */
            .sidebar-navigation {
                width: 260px; /* full width when open */
                transform: translateX(-100%);
                position: fixed;
                left: 0;
                top: 0;
            }
            
            .sidebar-navigation.mobile-hidden {
                transform: translateX(-100%);
            }
            
            /* When visible (remove mobile-hidden via JS), slide in */
            .sidebar-navigation:not(.mobile-hidden) {
                transform: translateX(0);
            }
            
            .brand-logo h1, .nav-item span {
                display: inline;
            }
            
            .main-content-area {
                margin-left: 0;
                width: 100%;
            }
            
            .main-content-area.full-width {
                margin-left: 0;
                width: 100%;
            }
            
            .brand-logo {
                justify-content: flex-start;
                padding: 0 25px 25px;
            }
            
            .nav-item {
                justify-content: flex-start;
                padding: 14px 25px;
            }
            
            .nav-item i {
                margin-right: 15px;
            }
            
            .mobile-menu-toggle {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            .dashboard-sections {
                grid-template-columns: 1fr;
            }

            .order-details-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .dashboard-cards {
                grid-template-columns: 1fr;
            }
            
            .header-bar {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .user-profile {
                align-self: flex-start;
                width: 100%;
                justify-content: space-between;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            /* Make tables horizontally scrollable without breaking layout */
            .data-table {
                min-width: 100%;
            }
            
            .product-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .order-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .item-quantity {
                align-self: flex-end;
            }

            .profile-details {
                grid-template-columns: 1fr;
            }

            .profile-header {
                flex-direction: column;
                text-align: center;
            }

            .profile-stats {
                justify-content: center;
            }
        }

        @media (max-width: 576px) {
            .main-content-area {
                padding: 15px;
            }
            
            .section-card {
                padding: 15px;
                width: 100%;
                overflow: hidden;
            }
            
            .dashboard-cards {
                gap: 15px;
            }
            
            .stat-card {
                padding: 20px;
            }
            
            .card-value {
                font-size: 28px;
            }
            
            .page-title h2 {
                font-size: 24px;
            }
            
            .product-grid {
                grid-template-columns: 1fr;
            }

            .profile-stats {
                flex-wrap: wrap;
            }
        }
    </style>
    
</head>
<body>
    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <div class="dashboard-container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar-navigation" id="sidebarNavigation">
            <div class="brand-logo">
                <img style="background-color: white; padding: 5px; height: 56px; border-radius: 50px;" src="images/logo/blushley-png-without-shade.png" alt="">
                <h1>BLUSHLEY</h1>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-page="dashboard">
                    <i class="fas fa-th-large"></i>
                    <span>Dashboard</span>
                </li>
             
                <li class="nav-item" data-page="products">
                    <i class="fas fa-box-open"></i>
                    <span>Product Management</span>
                </li>
                <li class="nav-item" data-page="orders">
                    <i class="fas fa-shopping-cart"></i>
                    <span>Order Management</span>
                </li>
                <li class="nav-item" data-page="account">
                    <i class="fas fa-user-circle"></i>
                    <span>Account Details</span>
                </li>
                <li class="nav-item">
                    <a href="/logout" style="display: flex; align-items: center; color: inherit; text-decoration: none;">
                        <i class="fas fa-sign-out-alt"></i>
                        <span style="margin-left: 8px;">Logout</span>
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content Area -->
        <main class="main-content-area" id="mainContentArea">
            <!-- Header Bar -->
            <div class="header-bar">
                <div class="page-title">
                    <h2 id="current-page-title">Reseller Dashboard</h2>
                    <p id="current-page-description">
                        Welcome back
                        <% if (resellers && resellers[0] && resellers[0].contactName) { %>
                            , <%= resellers[0].contactName %>
                        <% } %>!
                        Here&#39;s your reseller business overview.
                    </p>
                </div>
                <div class="user-profile">
                    <div class="user-avatar">
                        <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="<%= resellers && resellers[0] && resellers[0].contactName ? resellers[0].contactName : 'Reseller' %>">
                    </div>
                    <div class="user-info">
                        <h4>
                            <%= resellers && resellers[0] && resellers[0].contactName ? resellers[0].contactName : (resellers && resellers[0] && resellers[0].companyName ? resellers[0].companyName : 'Reseller') %>
                        </h4>
                        <p>
                            <%= resellers && resellers[0] && resellers[0].companyName ? resellers[0].companyName : '' %>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div class="page-content active" id="dashboard-page">
                <!-- Dashboard Cards -->
                <div class="dashboard-cards">
                    <div class="stat-card">
                        <div class="card-icon primary">
                            <i class="fas fa-boxes"></i>
                        </div>
                        <div class="card-value"><%= (resellers && resellers[0] && typeof resellers[0].totalSales !== "undefined") ? resellers[0].totalSales : 0 %></div>
                        <div class="card-label">Total Products</div>
                    </div>
                    <div class="stat-card">
                        <div class="card-icon success">
                            <i class="fas fa-shopping-cart"></i>
                        </div>
                        <div class="card-value"><%= (resellers && resellers[0] && typeof resellers[0].totalOrders !== "undefined") ? resellers[0].totalOrders : 0 %></div>
                        <div class="card-label">New Orders</div>
                    </div>
                    <div class="stat-card">
                        <div class="card-icon warning">
                            <i class="fas fa-tags"></i>
                        </div>
                        <div class="card-value"><%= (resellers && resellers[0] && Array.isArray(resellers[0].warehouses)) ? resellers[0].warehouses.length : 0 %></div>
                        <div class="card-label">Product Warehouses</div>
                    </div>
                    <div class="stat-card">
                        <div class="card-icon danger">
                            <i class="fas fa-rupee-sign"></i>
                        </div>
                        <div class="card-value">
                            ₹<%= (resellers && resellers[0] && typeof resellers[0].totalEarnings !== "undefined") ? resellers[0].totalEarnings.toLocaleString("en-IN") : "0" %>
                        </div>
                        <div class="card-label">Revenue To Date</div>
                    </div>
                </div>

                <!-- Dashboard Sections -->
                <div class="dashboard-sections">
                    <!-- Reseller Account Info -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">Reseller Account Info</h3>
                        </div>
                        <% if (resellers && resellers[0]) { %>
                        <div class="profile-details">
                            <div class="profile-field">
                                <span class="field-label">Business Name</span>
                                <span class="field-value"><%= resellers[0].companyName %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">GST No.</span>
                                <span class="field-value"><%= resellers[0].gstNo || "—" %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Contact Name</span>
                                <span class="field-value"><%= resellers[0].contactName %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Email</span>
                                <span class="field-value"><%= resellers[0].email %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Phone</span>
                                <span class="field-value"><%= resellers[0].phone %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Status</span>
                                <span class="field-value">
                                    <% if (resellers[0].status === "approved") { %>
                                        <span class="status-badge status-confirmed">Approved</span>
                                    <% } else if (resellers[0].status === "pending") { %>
                                        <span class="status-badge status-pending">Pending</span>
                                    <% } else if (resellers[0].status === "rejected") { %>
                                        <span class="status-badge status-rejected">Rejected</span>
                                    <% } else if (resellers[0].status === "disabled") { %>
                                        <span class="status-badge status-disabled">Disabled</span>
                                    <% } %>
                                </span>
                            </div>
                            <% if(resellers[0].status === "rejected" && resellers[0].rejectionReason) { %>
                            <div class="profile-field">
                                <span class="field-label">Rejection Reason</span>
                                <span class="field-value"><%= resellers[0].rejectionReason %></span>
                            </div>
                            <% } %>
                        </div>
                        <% } else { %>
                        <div class="profile-details">
                            <div>No reseller data found.</div>
                        </div>
                        <% } %>
                    </div>
                    <!-- Warehouses (if any) -->
                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">Warehouses</h3>
                            <% if (resellers && resellers[0] && Array.isArray(resellers[0].warehouses) && resellers[0].warehouses.length > 0) { %>
                                <span class="field-value" style="font-size: 90%; color: #888;">Total: <%= resellers[0].warehouses.length %></span>
                            <% } %>
                        </div>
                        <% if (resellers && resellers[0] && Array.isArray(resellers[0].warehouses) && resellers[0].warehouses.length > 0) { %>
                            <div class="table-responsive">
                                <table class="data-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Address</th>
                                            <th>City</th>
                                            <th>State</th>
                                            <th>Pincode</th>
                                            <th>Phone</th>
                                            <th>Is Default</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% resellers[0].warehouses.forEach(function(wh) { %>
                                            <tr>
                                                <td><%= wh.name %></td>
                                                <td><%= wh.address || '-' %></td>
                                                <td><%= wh.city || '-' %></td>
                                                <td><%= wh.state || '-' %></td>
                                                <td><%= wh.pincode || '-' %></td>
                                                <td><%= wh.phone || '-' %></td>
                                                <td>
                                                    <% if (wh.isDefault) { %>
                                                        <span class="status-badge status-confirmed">Default</span>
                                                    <% } else { %>
                                                        <span class="status-badge status-secondary">No</span>
                                                    <% } %>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        <% } else { %>
                            <div style="font-size: 90%; color: #999; margin:1em 0 1em 1em;">No warehouse records available.</div>
                        <% } %>
                    </div>
                </div>
            </div>

            <!-- Products Page -->
<div class="page-content" id="products-page">
    <div class="section-card" style="background: linear-gradient(135deg, #f7f6fa, #f3f7fd 75%); border:none;">
        <div class="section-header" style="background: none; border-bottom: 2px solid #eadcf1; border-radius: 18px 18px 0 0;">
            <h3 class="section-title" style="font-weight: 700; color: #9c27b0; letter-spacing:0.03em">Product Management</h3>
            <button class="action-button add-button" id="add-product-btn" type="button" style="background: linear-gradient(90deg,#e040fb,#7c4dff); color: #fff; border-radius: 24px; box-shadow:0 2px 8px #e1d1ff;">
                <i class="fas fa-plus"></i> Add Product
            </button>
        </div>
        <div class="filters-bar" style="margin: 16px 0 26px 0; display:flex; gap:14px; align-items: flex-end; flex-wrap:wrap;">
            <div>
                <label style="font-size:92%; color:#9266aa;">Category</label>
                <select id="filter-category" class="form-select" style="min-width:120px;">
                    <option value="">All</option>
                    <% (categories||[]).forEach(function(c){ %>
                        <option value="<%= c._id %>"><%= c.name %></option>
                    <% }) %>
                </select>
            </div>
            <div>
                <label style="font-size:92%; color:#9266aa;">Subcategory</label>
                <select id="filter-subCategory" class="form-select" style="min-width:120px;">
                    <option value="">All</option>
                    <% (subCategories||[]).forEach(function(sc){ %>
                        <option value="<%= sc._id %>"><%= sc.name %></option>
                    <% }) %>
                </select>
            </div>
            <div>
                <label style="font-size:92%; color:#9266aa;">Child Category</label>
                <select id="filter-childCategory" class="form-select" style="min-width:120px;">
                    <option value="">All</option>
                    <% (childCategories||[]).forEach(function(cc){ %>
                        <option value="<%= cc._id %>"><%= cc.name %></option>
                    <% }) %>
                </select>
            </div>
            <div>
                <button type="button" id="clear-product-filters" class="action-button secondary-button" style="margin-left:5px;background:#f7e5f7;color:#9c27b0;border-radius:16px;">Clear</button>
            </div>
        </div>
        <div id="product-card-grid" class="product-cards-grid"></div>
    </div>
</div>

<div class="modal-overlay" id="product-modal" style="display:none;">
    <div class="modal large-modal" style="background:linear-gradient(120deg, #fff1f7 40%, #f0f8ff 100%);box-shadow:0 10px 36px #d4b1fc7a;">
        <div class="modal-header" style="background: linear-gradient(90deg,#fce4ec 15%,#ede7f6 100%); border-radius: 14px 14px 0 0;">
            <h3 class="modal-title" id="product-modal-title" style="color: #ba68c8;">Add Product</h3>
            <button class="modal-close" id="close-product-modal" type="button" style="color:#c77fdf;">&times;</button>
        </div>
        <div class="modal-body" style="background:rgba(255,255,255,0.96);padding:28px 34px 18px 34px;">
            <form id="product-form" autocomplete="off">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label class="form-label" style="color:#aa5dc7;">Product Images <span style="font-size:90%;color:#888;">(Max 6)</span></label>
                    <div id="main-image-wrapper" class="images-wrapper"></div>
                    <label class="upload-btn mt-2" style="background:#e1bee7;border-radius:18px;">
                        <i class="fas fa-upload"></i> Add Image
                        <input type="file" id="add-main-image" accept="image/*" hidden multiple>
                    </label>
                </div>
                <div class="form-row">
                    <div class="form-group col-6">
                        <label class="form-label">Product Name <span style="color:#d00">*</span></label>
                        <input type="text" id="title" class="form-input" required>
                    </div>
                    <div class="form-group col-6">
                        <label>Brand</label>
                        <input type="text" id="brand" class="form-input">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-4">
                        <label>Category</label>
                        <select id="category" class="form-select" required>
                            <option value="">Select</option>
                            <% (categories||[]).forEach(function(c){ %>
                                <option value="<%= c._id %>"><%= c.name %></option>
                            <% }) %>
                        </select>
                    </div>
                    <div class="form-group col-4">
                        <label>Subcategory</label>
                        <select id="subCategory" class="form-select">
                            <option value="">Select</option>
                        </select>
                    </div>
                    <div class="form-group col-4">
                        <label>Child Category</label>
                        <select id="childCategory" class="form-select">
                            <option value="">Select</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Short Description <span style="color:#aaa">(one-liner summary)</span></label>
                    <textarea class="form-input" id="shortDescription" maxlength="200" rows="2" style="resize:none"></textarea>
                </div>
                <div class="form-group">
                    <label>Description <span style="color:#aaa">(detailed)</span></label>
                    <textarea class="form-input form-textarea" id="description" style="height:80px"></textarea>
                </div>
                <div class="form-group">
                    <label>How to Use</label>
                    <input type="text" id="howToUse" class="form-input">
                </div>
                <div class="form-row">
                  <div class="form-group col-4">
                    <label>Base Price <span style="color:#bbb;">(MRP)</span></label>
                    <input type="number" id="basePrice" class="form-input" min="0">
                  </div>
                  <div class="form-group col-4">
                    <label>Sale Price <span style="color:#bbb;">(Discounted)</span></label>
                    <input type="number" id="salePrice" class="form-input" min="0">
                  </div>
                  <div class="form-group col-4">
                    <label>Total Stock</label>
                    <input type="number" id="totalStock" class="form-input" min="0">
                  </div>
                </div>
                <div class="form-row">
                  <div class="form-group col-6">
                      <label>Weight (in g/ml)</label>
                      <input type="number" id="weight" class="form-input" min="0" step="any">
                  </div>
                  <div class="form-group col-6">
                      <label>Dimensions (L x W x H in cm, comma separated)</label>
                      <input type="text" id="dimensions" class="form-input" placeholder="e.g. 16,10,8">
                  </div>
                </div>
                <div class="form-group">
                    <label style="display:block;margin-bottom:6px;font-weight:600;color:#8d47ab;">
                        Beauty Tips <span style="color:#aaa;font-weight:400;">(pick from list or add custom)</span>
                    </label>
                    <% if (Array.isArray(beautyTips) && beautyTips.length) { %>
                        <div id="beauty-tips-select-list" class="pill-box" style="flex-wrap:wrap; margin-bottom:5px;">
                          <% beautyTips.forEach(function(tip, i) { %>
                            <label class="pill" style="background:#ede7f6;color:#7b1fa2;font-weight:500;display:inline-flex;align-items:center;margin-bottom:5px;">
                                <input 
                                type="checkbox"
                                class="beauty-tip-checkbox"
                                value="<%- tip._id %>"
                                data-tipid="<%- tip._id %>"
                              />
                              
                              <span style="font-weight:600;">
                                <%= tip.title ? tip.title : tip.text %>
                              </span>
                              <% if (tip.title && tip.text && tip.text !== tip.title) { %>
                                <span style="font-size:95%;color:#674581;font-weight:400;margin-left:7px;">– <%= tip.text %></span>
                              <% } %>
                            </label>
                          <% }) %>
                        </div>
                    <% } else { %>
                        <span style="color:#bbb">No beauty tips</span>
                    <% } %>
                    <div id="beauty-tips-wrapper" class="pill-box"></div>
                </div>
                <div class="form-row">
                  <div class="form-group col-4">
                      <label>Tags</label>
                      <div id="tags-wrapper" class="pill-box"></div>
                      <input type="text" id="tag-input" class="form-input" placeholder="Press Enter to add">
                  </div>
                  <div class="form-group col-4">
                      <label>Ingredients</label>
                      <div id="ingredients-wrapper" class="pill-box"></div>
                      <input type="text" id="ingredient-input" class="form-input" placeholder="Press Enter to add">
                  </div>
                  <div class="form-group col-4">
                      <label>Benefits</label>
                      <div id="benefits-wrapper" class="pill-box"></div>
                      <input type="text" id="benefit-input" class="form-input" placeholder="Press Enter to add">
                  </div>
                </div>
                <div class="form-group">
                    <label>Variants</label>
                    <div id="variant-list"></div>
                    <button type="button" id="add-variant-btn" class="action-button mt-2" style="background:#d1c4e9;color:#663099;">+ Add Variant</button>
                </div>
                <div class="form-group" style="margin-top:10px;">
                    <label>SEO Meta Title</label>
                    <input type="text" id="seo-title" class="form-input">
                </div>
                <div class="form-group">
                    <label>SEO Meta Description</label>
                    <textarea class="form-input" id="seo-description"></textarea>
                </div>
                <div class="form-group">
                    <label>SEO Keywords</label>
                    <div id="seo-keywords-wrapper" class="pill-box"></div>
                    <input type="text" id="seo-keyword-input" placeholder="Press Enter to add" class="form-input">
                </div>
            </form>
        </div>
        <div class="modal-footer" style="background:linear-gradient(90deg,#f3e5f5,#e3f2fd);border-radius:0 0 14px 14px;">
            <button class="action-button secondary-button" id="cancel-product-btn" type="button" style="background:#ede7f6;color:#8d6ebf;">Cancel</button>
            <button class="action-button confirm-button" id="save-product-btn" type="button" style="background:#ab47bc;color:#fff;">Save Product</button>
        </div>
    </div>
</div>

<!-- SweetAlert2 CDN -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
(function() {
    // Global API functions
    window.showProductModal = showProductModal;
    window.closeProductModal = closeProductModal;
    window.editProduct = editProduct;
    window.toggleProductStatus = toggleProductStatus;
    window.deleteProduct = deleteProduct;
    window.populateProductForm = populateProductForm;
    window.resetProductForm = resetProductForm;

    // Variables
    const categories = <%- JSON.stringify(categories || []) %>;
    const subCategories = <%- JSON.stringify(subCategories || []) %>;
    const childCategories = <%- JSON.stringify(childCategories || []) %>;
    const beautyTips = <%- JSON.stringify(beautyTips || []) %>;
    let beautyTipsSelected = [];
    let variantImagesMap = {};
    let mainImages = [];
    let variants = [];
    const filterVals = { category: "", subCategory: "", childCategory: "" };

    function getSubcategories(categoryId) {
        if (!categoryId) return [];
        return subCategories.filter(sub =>
            sub.categoryId && sub.categoryId.toString() === categoryId.toString()
        );
    }
    function getChildCategories(subCategoryId, categoryId) {
        if (!subCategoryId || !categoryId) return [];
        return childCategories.filter(child =>
            child.subCategoryId && child.subCategoryId.toString() === subCategoryId.toString() &&
            child.categoryId && child.categoryId.toString() === categoryId.toString()
        );
    }
    function getSanitizedBeautyTips() {
        return beautyTipsSelected
            .map(v => typeof v === 'string' ? v.trim() : v)
            .filter(v =>
                v && !(typeof v === 'string' && v === '')
                && !(typeof v === 'string' && /^[\s]*$/.test(v)) 
            )
            .filter((v, i, arr) => arr.indexOf(v) === i);
    }
    function renderBeautyTipSelection() {
        const checkboxes = document.querySelectorAll('.beauty-tip-checkbox');
        const tipsWrap = document.getElementById("beauty-tips-wrapper");
        tipsWrap.innerHTML = "";
        beautyTipsSelected.forEach((txt, idx) => {
            const pill = document.createElement("div");
            pill.className = "pill";
            pill.innerHTML = `${txt} <span class="pill-remove" style='user-select:none;'>×</span>`;
            pill.querySelector(".pill-remove").onclick = () => {
                beautyTipsSelected.splice(idx, 1);
                Array.from(checkboxes).forEach(cb => {
                    if (cb.value === txt) cb.checked = false;
                });
                renderBeautyTipSelection();
            };
            tipsWrap.appendChild(pill);
        });
    }
    // --- SweetAlert helpers ---
    function swalAlert(text, icon = "info") {
        return Swal.fire({
            text,
            icon,
            confirmButtonColor: "#ab47bc"
        });
    }
    function swalConfirm(text, icon = "warning") {
        return Swal.fire({
            text,
            icon,
            showCancelButton: true,
            confirmButtonColor: "#ab47bc",
            cancelButtonColor: "#bdbdbd",
            confirmButtonText: "Yes",
            cancelButtonText: "Cancel"
        });
    }

    // Main initialization
    document.addEventListener("DOMContentLoaded", function() {
        // Add Product Modal Button
        document.getElementById("add-product-btn").addEventListener("click", function() {
            showProductModal(false);
        });
        document.getElementById("close-product-modal").addEventListener("click", closeProductModal);
        document.getElementById("cancel-product-btn").addEventListener("click", closeProductModal);
        document.getElementById("product-modal").addEventListener("click", function(e) {
            if (e.target === this) closeProductModal();
        });

        // Filters
        document.getElementById('filter-category').addEventListener('change', function() {
            filterVals.category = this.value;
            const filterSubCategory = document.getElementById('filter-subCategory');
            const filterChildCategory = document.getElementById('filter-childCategory');
            filterSubCategory.innerHTML = '<option value="">All</option>';
            filterChildCategory.innerHTML = '<option value="">All</option>';
            if (this.value) {
                const subs = getSubcategories(this.value);
                subs.forEach(sc => {
                    filterSubCategory.innerHTML += `<option value="${sc._id}">${sc.name}</option>`;
                });
                filterSubCategory.disabled = false;
            } else {
                filterSubCategory.disabled = true;
            }
            filterVals.subCategory = "";
            filterVals.childCategory = "";
            filterChildCategory.disabled = true;
            loadProductList();
        });
        document.getElementById('filter-subCategory').addEventListener('change', function() {
            filterVals.subCategory = this.value;
            const filterCategory = document.getElementById('filter-category');
            const filterChildCategory = document.getElementById('filter-childCategory');
            filterChildCategory.innerHTML = '<option value="">All</option>';
            if (this.value && filterCategory.value) {
                const children = getChildCategories(this.value, filterCategory.value);
                children.forEach(ch => {
                    filterChildCategory.innerHTML += `<option value="${ch._id}">${ch.name}</option>`;
                });
                filterChildCategory.disabled = false;
            } else {
                filterChildCategory.disabled = true;
            }
            filterVals.childCategory = "";
            loadProductList();
        });
        document.getElementById('filter-childCategory').addEventListener('change', function() {
            filterVals.childCategory = this.value;
            loadProductList();
        });
        document.getElementById('clear-product-filters').onclick = () => {
            document.getElementById('filter-category').value = "";
            document.getElementById('filter-subCategory').innerHTML = `<option value="">All</option>`;
            document.getElementById('filter-childCategory').innerHTML = `<option value="">All</option>`;
            document.getElementById('filter-subCategory').disabled = true;
            document.getElementById('filter-childCategory').disabled = true;
            filterVals.category = "";
            filterVals.subCategory = "";
            filterVals.childCategory = "";
            loadProductList();
        };

        // Category dropdowns in form
        const catSel = document.getElementById("category"),
            subSel = document.getElementById("subCategory"),
            childSel = document.getElementById("childCategory");
        catSel.onchange = function() {
            subSel.innerHTML = "<option value=''>Select</option>";
            childSel.innerHTML = "<option value=''>Select</option>";
            if (this.value) {
                const subs = getSubcategories(this.value);
                subs.forEach(sc => {
                    subSel.innerHTML += `<option value="${sc._id}">${sc.name}</option>`;
                });
                subSel.disabled = false;
            } else {
                subSel.disabled = true;
            }
            childSel.disabled = true;
        };
        subSel.onchange = function() {
            childSel.innerHTML = "<option value=''>Select</option>";
            if (this.value && catSel.value) {
                const children = getChildCategories(this.value, catSel.value);
                children.forEach(ch => {
                    childSel.innerHTML += `<option value="${ch._id}">${ch.name}</option>`;
                });
                childSel.disabled = false;
            } else {
                childSel.disabled = true;
            }
        };

        // Beauty Tips
        const tipsSel = document.getElementById("beauty-tips-select-list");
        if (tipsSel) {
            tipsSel.addEventListener('change', function(e) {
                if (!e.target.classList.contains('beauty-tip-checkbox')) return;
                const tip = e.target.value;
                if (e.target.checked) {
                    if (!!tip &&
                        !beautyTipsSelected.map(v => (typeof v === 'string' ? v.trim() : v)).includes(typeof tip === 'string' ? tip.trim() : tip)
                    ) {
                        beautyTipsSelected.push(tip);
                    }
                } else {
                    beautyTipsSelected = beautyTipsSelected.filter(t =>
                        (typeof t === 'string' ? t.trim() : t) !== (typeof tip === 'string' ? tip.trim() : tip)
                    );
                }
                renderBeautyTipSelection();
            });
        }
        renderBeautyTipSelection();

        // Pill input handling (tags, ingredients, benefits, SEO keywords)
        function setupPillInput(inputId, wrapperId) {
            const input = document.getElementById(inputId);
            const wrap = document.getElementById(wrapperId);
            let items = [];
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    const val = input.value.trim();
                    if(!val) return;
                    items.push(val);
                    render();
                    input.value = "";
                }
            });
            function render() {
                wrap.innerHTML = "";
                items.forEach((txt, idx) => {
                    const pill = document.createElement("div");
                    pill.className = "pill";
                    pill.innerHTML = `${txt} <span class="pill-remove" style='user-select:none;'>×</span>`;
                    pill.querySelector(".pill-remove").onclick = () => {
                        items.splice(idx, 1);
                        render();
                    };
                    wrap.appendChild(pill);
                });
            }
            return () => items;
        }
        window.getTags = setupPillInput("tag-input", "tags-wrapper");
        window.getIngredients = setupPillInput("ingredient-input", "ingredients-wrapper");
        window.getBenefits = setupPillInput("benefit-input", "benefits-wrapper");
        window.getSeoKeywords = setupPillInput("seo-keyword-input", "seo-keywords-wrapper");

        // Image Handling
        document.getElementById("add-main-image").addEventListener("change", (e) => {
            const files = Array.from(e.target.files);
            if(!files.length) return;
            files.forEach(file => {
                if(mainImages.length < 6) {
                    const url = URL.createObjectURL(file);
                    mainImages.push({ file, url });
                }
            });
            renderMainImages();
            e.target.value = "";
        });
        function renderMainImages() {
            const wrap = document.getElementById("main-image-wrapper");
            wrap.innerHTML = "";
            mainImages.forEach((img, i) => {
                const box = document.createElement("div");
                box.className = "image-box";
                box.innerHTML = `
                    <img src="${img.url}">
                    <div class="image-actions">
                        <button type="button" data-i="${i}">X</button>
                    </div>`;
                box.querySelector("button").onclick = () => { mainImages.splice(i,1); renderMainImages(); }
                wrap.appendChild(box);
            });
        }
        window.renderMainImages = renderMainImages;

        // VARIANT HANDLING
        document.getElementById("add-variant-btn").onclick = function(e) {
            e.preventDefault();
            const id = Date.now() + Math.floor(Math.random() * 1000);
            variants.push({ id, name: "", options: [] });
            renderVariants();
        };
        window.renderVariants = renderVariants;
        function renderVariants() {
            const list = document.getElementById("variant-list");
            list.innerHTML = "";
            variants.forEach((v, vi) => {
                const vb = document.createElement("div");
                vb.className = "variant-box";
                vb.innerHTML = `
                    <label class="option-label" style="margin-bottom:6px;">Variant Name</label>
                    <input class="form-input" placeholder="eg: Color / Size" value="${v.name}"
                        oninput="window.updateVariantName(this, ${vi})">
                    <button type="button" class="action-button mt-2 add-variant-opt" data-vi="${vi}" style="margin-top:9px;background:#e1bee7;color:#663099;">+ Add Option</button>
                    <div class="variant-options"></div>
                `;
                vb.querySelector(".add-variant-opt").onclick = function(evt) {
                    evt.preventDefault();
                    const oid = Date.now() + Math.floor(Math.random() * 1000);
                    v.options.push({
                        id: oid,
                        value: "",
                        stock: 0,
                        price: 0
                    });
                    renderVariants();
                };
                const opts = vb.querySelector(".variant-options");
                v.options.forEach((o, oi) => {
                    const optionId = o.id;
                    if (!variantImagesMap[v.id]) variantImagesMap[v.id] = {};
                    if (!variantImagesMap[v.id][optionId]) variantImagesMap[v.id][optionId] = [];
                    const images = variantImagesMap[v.id][optionId];

                    const ob = document.createElement("div");
                    ob.className = "option-box";
                    ob.innerHTML = `
                        <div>
                          <label class="option-label">Option Value</label>
                          <input class="form-input" placeholder="eg: Red / XL" value="${o.value}"
                              oninput="window.updateOptionValue(${vi}, ${oi}, this.value)">
                        </div>
                        <div>
                          <label class="option-label">Stock</label>
                          <input class="form-input mt-1" type="number" placeholder="Stock" value="${o.stock}"
                              oninput="window.updateOptionStock(${vi}, ${oi}, this.value)">
                        </div>
                        <div>
                          <label class="option-label">Price</label>
                          <input class="form-input mt-1" type="number" placeholder="Price" value="${o.price}"
                              oninput="window.updateOptionPrice(${vi}, ${oi}, this.value)">
                        </div>
                        <div>
                          <label class="option-label">Images (max 4)</label>
                          <div class="variant-image-wrapper" id="variant-images-${v.id}-${optionId}" style="display:flex;gap:4px;flex-wrap:wrap;margin-bottom:4px;"></div>
                          <label class="upload-btn mt-1" style="background:#e1bee7;border-radius:14px;">
                            <i class="fas fa-upload"></i> Add Images
                            <input type="file" accept="image/*" hidden multiple id="add-variant-image-${v.id}-${optionId}">
                          </label>
                        </div>
                        <button type="button" class="pill-remove"
                            title="Remove Option" style="margin-top:8px;margin-left:8px;font-size:15px;grid-column:1/4;max-width:148px;">× Remove Option</button>
                    `;
                    ob.querySelector("button").onclick = function(evt) {
                        evt.preventDefault();
                        v.options.splice(oi, 1);
                        if (variantImagesMap[v.id] && variantImagesMap[v.id][optionId]) {
                            delete variantImagesMap[v.id][optionId];
                        }
                        renderVariants();
                    };
                    // --- Variant images preview ---
                    setTimeout(() => {
                        const imgWrap = document.getElementById(`variant-images-${v.id}-${optionId}`);
                        if (imgWrap) {
                            imgWrap.innerHTML = "";
                            (images || []).forEach((img, idx) => {
                                const box = document.createElement("div");
                                box.className = "image-box";
                                box.innerHTML = `
                                    <img src="${img.url}" style="width:54px;height:54px;object-fit:cover;border-radius:8px;border:1.5px solid #c1b4e7;">
                                    <div class="image-actions">
                                        <button type="button" data-i="${idx}" style="font-size:13px;">X</button>
                                    </div>
                                `;
                                box.querySelector("button").onclick = () => {
                                    images.splice(idx, 1);
                                    renderVariants();
                                };
                                imgWrap.appendChild(box);
                            });
                        }
                    }, 0);
                    setTimeout(() => {
                        const inputId = `add-variant-image-${v.id}-${optionId}`;
                        const inputEl = document.getElementById(inputId);
                        if (inputEl) {
                            inputEl.onchange = (e) => {
                                const files = Array.from(e.target.files);
                                if(!files.length) return;
                                files.forEach(file => {
                                    if(images.length < 4) { // limit to 4 images per option
                                        const url = URL.createObjectURL(file);
                                        images.push({ file, url });
                                    }
                                });
                                renderVariants();
                                e.target.value = "";
                            };
                        }
                    }, 0);
                    opts.appendChild(ob);
                });
                if(variants.length > 1) {
                    const remBtn = document.createElement("button");
                    remBtn.type = "button";
                    remBtn.className = "pill-remove";
                    remBtn.textContent = "Remove Variant";
                    remBtn.style = "margin-top:10px;color:#E74C3C;";
                    remBtn.onclick = function(evt) {
                        evt.preventDefault();
                        if (variantImagesMap[v.id]) delete variantImagesMap[v.id];
                        variants.splice(vi,1);
                        renderVariants();
                    };
                    vb.appendChild(remBtn);
                }
                list.appendChild(vb);
            });
        }
        window.updateVariantName = function(el, idx) {
            variants[idx].name = el.value;
        };
        window.updateOptionValue = function(vi, oi, val) {
            variants[vi].options[oi].value = val;
        };
        window.updateOptionStock = function(vi, oi, val) {
            variants[vi].options[oi].stock = Number(val) || 0;
        };
        window.updateOptionPrice = function(vi, oi, val) {
            variants[vi].options[oi].price = Number(val) || 0;
        };

        // -- Save Product --
        document.getElementById("save-product-btn").onclick = async () => {
            const btn = document.getElementById("save-product-btn");
            btn.disabled = true;
            const origTxt = btn.innerHTML;
            btn.innerHTML = `<i class="fa fa-spinner fa-spin"></i> Saving...`;

            const fd = new FormData();
            fd.append("title", document.getElementById("title").value);
            fd.append("brand", document.getElementById("brand").value);
            fd.append("shortDescription", document.getElementById("shortDescription").value);
            fd.append("description", document.getElementById("description").value);
            fd.append("howToUse", document.getElementById("howToUse").value);
            fd.append("category", document.getElementById("category").value);
            fd.append("subCategory", document.getElementById("subCategory").value);
            fd.append("childCategory", document.getElementById("childCategory").value);
            fd.append("basePrice", document.getElementById("basePrice").value);
            fd.append("salePrice", document.getElementById("salePrice").value);
            fd.append("totalStock", document.getElementById("totalStock").value);
            fd.append("weight", document.getElementById("weight").value || '');

            let dims = document.getElementById("dimensions").value.trim();
            if (dims) {
                let arr = dims.split(",").map(d => d.trim()).filter(Boolean);
                fd.append("dimensions", JSON.stringify(arr));
            }

            fd.append("tags", JSON.stringify(getTags().slice()));
            fd.append("ingredients", JSON.stringify(getIngredients().slice()));
            fd.append("benefits", JSON.stringify(getBenefits().slice()));

            const sanitizedBeautyTips = beautyTipsSelected.filter(id => /^[a-f0-9]{24}$/i.test(id));
            fd.append("beautyTips", JSON.stringify(sanitizedBeautyTips.length ? sanitizedBeautyTips : []));

            // Build variants and gather all files
            let sanVariants = variants.map(variant => ({
                id: variant.id,
                name: variant.name,
                options: (variant.options || []).map(o => ({
                    id: o.id,
                    value: o.value,
                    stock: o.stock,
                    price: o.price,
                    images: (variantImagesMap[variant.id] && variantImagesMap[variant.id][o.id])
                        ? variantImagesMap[variant.id][o.id]
                            .map(img => img.file ? null : img.url)
                            .filter(Boolean)
                        : []
                }))
            }));

            fd.append("variants", JSON.stringify(sanVariants));
            fd.append("seo", JSON.stringify({
                title: document.getElementById("seo-title").value,
                description: document.getElementById("seo-description").value,
                keywords: getSeoKeywords().slice()
            }));

            mainImages.forEach(img => {
                if (img.file) fd.append("images", img.file);
            });

            for (const variantId in variantImagesMap) {
                for (const optionId in variantImagesMap[variantId]) {
                    const images = variantImagesMap[variantId][optionId] || [];
                    images.forEach((img, idx) => {
                        if (img.file) {
                            fd.append(`variantFile__${variantId}__${optionId}`, img.file);
                        }
                    });
                }
            }
            const id = document.getElementById("product-id").value;
            const url = id ? `/reseller/products/edit/${id}` : `/reseller/products/create`;

            let errMsg = null;
            try {
                const res = await fetch(url, { method: "POST", body: fd });
                const data = await res.json();
                if (data.success) {
                    await Swal.fire({
                        icon: "success",
                        text: "Product Saved",
                        timer: 1800,
                        showConfirmButton: false,
                    });
                    closeProductModal();
                    loadProductList();
                } else {
                    errMsg = "Error: " + (data.error || "Unknown error");
                }
            } catch(err) {
                errMsg = "Failed to save: " + (err.message || err);
            }
            if (errMsg) {
                await swalAlert(errMsg, "error");
            }
            btn.innerHTML = origTxt;
            btn.disabled = false;
        };

        // Initial product load
        loadProductList();
    }); // end DOMContentLoaded

    // Product list loader & fetch
    function loadProductList() {
        var grid = document.getElementById("product-card-grid");
        if (!grid) return;
        grid.innerHTML = `<div style="text-align:center;padding:48px 0;color:#aaa;font-size:120%;">Loading...</div>`;
        fetchProductList().then(data => {
            if (!data.success || !data.products || !data.products.length) {
                grid.innerHTML = `<div style="text-align:center;padding:44px 0;color:#bbb;font-size:118%;">No products found.</div>`;
                return;
            }
            grid.innerHTML = "";
            data.products.forEach(prod => {
                // Get images
                let imgList = Array.isArray(prod.images) ? prod.images : [];
                let imgUrl = imgList.length ? (typeof imgList[0] === "string" ? imgList[0] : (imgList[0].url || '/images/noimage.png')) : '/images/noimage.png';
                // Category chain
                let categoryName = prod.category && prod.category.name ? prod.category.name : (prod.categoryName || "-");
                let subCategoryName = prod.subCategory && prod.subCategory.name ? prod.subCategory.name : (prod.subCategoryName || "");
                let childCategoryName = prod.childCategory && prod.childCategory.name ? prod.childCategory.name : (prod.childCategoryName || "");
                let catChain = categoryName;
                if (subCategoryName) catChain += ` / ${subCategoryName}`;
                if (childCategoryName) catChain += ` / ${childCategoryName}`;

                // Info grid
                let dimensions = "-";
                if (prod.dimensions && typeof prod.dimensions === "object" && prod.dimensions !== null) {
                    const { length, width, height } = prod.dimensions;
                    dimensions = [length, width, height].filter(x => !!x || x === 0).join(" x ") || "-";
                } else if (prod.dimensions && Array.isArray(prod.dimensions)) {
                    dimensions = prod.dimensions.join(" x ");
                }
                let infoGrid = `
                    <div class="info-row">
                        <div><b>ID:</b> <span>${prod._id}</span></div>
                        <div><b>Status:</b> <span class="status-badge ${prod.status === 'active' ? 'status-confirmed' : 'status-pending'}">${prod.status || 'pending'}</span></div>
                        <div><b>Brand:</b> <span>${prod.brand || '-'}</span></div>
                        <div><b>Type:</b> <span>${prod.productType || '-'}</span></div>
                    </div>
                    <div class="info-row">
                        <div><b>Stock:</b> <span>${prod.totalStock || 0}</span></div>
                        <div><b>MRP:</b> ₹${prod.basePrice || '-'}</div>
                        <div><b>Sale:</b> ₹${prod.salePrice ? prod.salePrice : prod.basePrice || '-'}</div>
                        <div><b>Total Sold:</b> <span>${prod.totalSold || 0}</span></div>
                    </div>
                    <div class="info-row">
                        <div><b>Weight:</b> <span>${prod.weight || '-'}</span></div>
                        <div><b>Dimensions:</b> <span>${dimensions}</span></div>
                        <div><b>Rating:</b> <span>${prod.rating || 0}</span></div>
                        <div><b>Reviews:</b> <span>${prod.totalReviews || 0}</span></div>
                    </div>
                `;

                // Variants
                let variantsArr = Array.isArray(prod.variants) ? prod.variants : [];
                let variantsHtml = variantsArr.length ? `
                    <div class="info-row">
                        <div style="min-width:80px;"><b>Variants:</b></div>
                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;">
                            ${
                                variantsArr.map(variant => {
                                    let opts = (variant.options || []).map(o =>
                                        `<span class="variant-pill"
                                            title="Price: ₹${o.price || "-"}, Stock: ${o.stock || 0}">
                                                ${o.value}
                                        </span>`
                                    ).join(" ");
                                    return `<span class="pill" title="Variant Options">${variant.name || "Untitled"}</span> ${opts}`;
                                }).join("")
                            }
                        </div>
                    </div>
                ` : "";

                // Beauty Tips
                let btipsArr = Array.isArray(prod.beautyTips) ? prod.beautyTips : [];
                let beautyTipsHtml = btipsArr.length
                  ? `<div class="info-row"><div style="min-width:80px;"><b>Beauty Tips:</b></div><div style="flex:1;display:flex;flex-wrap:wrap;gap:4px;">
                    ${
                        btipsArr.map(tip =>
                            (typeof tip === 'object' && tip.title)
                              ? `<span class="pill" title="${tip.text || ''}">${tip.title}</span>`
                              : `<span class="pill">${tip}</span>`
                        ).join("")
                    }
                  </div></div>`
                  : "";

                // Images
                let imageSection = `
                    <div class="img-masonry" style="display:flex;gap:4px;margin-bottom:7px;">
                        ${
                            imgList.length ?
                                imgList.slice(0, 3).map(url =>
                                    `<img src="${typeof url === 'string' ? url : (url.url || '')}" style="width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #eee;" loading="lazy" />`
                                ).join("")
                            : `<img src="/images/noimage.png" style="width:55px;height:55px;object-fit:cover;border-radius:6px;border:1px solid #eee;" />`
                        }
                        ${imgList.length > 3 ? `<span style="align-self:center;font-size:90%;color:#999;">+${imgList.length - 3}</span>` : ""}
                    </div>
                `;

                // SEO
                let seo = prod.seo || {};
                let seoHtml = (seo.title || (seo.keywords && seo.keywords.length))
                    ? `<div style="font-size:90%;color:#9f7cbc;line-height:1.5;margin-top:3px;">
                        <b>SEO:</b>
                        ${seo.title ? `<span style="margin-right:7px;">${seo.title}</span>` : ""}
                        ${(seo.keywords && seo.keywords.length) ? seo.keywords.map(k => `<span class="pill">${k}</span>`).join("") : ""}
                       </div>`
                    : '';

                // Tags
                let tagsArr = Array.isArray(prod.tags) ? prod.tags : [];
                let tagsHtml = `
                    <div class="info-row" style="flex-wrap:wrap;">
                        <div style="min-width:80px;"><b>Tags:</b></div>
                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:3px;">
                            ${tagsArr.length ? tagsArr.map(t => `<span class="pill">${t}</span>`).join('') : '<span style="color:#bbb">None</span>'}
                        </div>
                    </div>
                `;
                // Ingredients
                let ingredientsArr = Array.isArray(prod.ingredients) ? prod.ingredients : [];
                let ingredientsHtml = `
                    <div class="info-row" style="flex-wrap:wrap;">
                        <div style="min-width:80px;"><b>Ingredients:</b></div>
                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:3px;">
                            ${ingredientsArr.length ? ingredientsArr.map(t => `<span class="pill">${t}</span>`).join('') : '<span style="color:#bbb">None</span>'}
                        </div>
                    </div>
                `;
                // Benefits
                let benefitsArr = Array.isArray(prod.benefits) ? prod.benefits : [];
                let benefitsHtml = `
                    <div class="info-row" style="flex-wrap:wrap;">
                        <div style="min-width:80px;"><b>Benefits:</b></div>
                        <div style="flex:1;display:flex;flex-wrap:wrap;gap:3px;">
                            ${benefitsArr.length ? benefitsArr.map(b => `<span class="pill">${b}</span>`).join('') : '<span style="color:#bbb">None</span>'}
                        </div>
                    </div>
                `;

                // Description fields
                let descHtml = `
                    <div class="info-row">
                        <div><b>Short Description:</b></div>
                        <div style="flex:1;color:#555;">${prod.shortDescription || '-'}</div>
                    </div>
                    <div class="info-row">
                        <div><b>Description:</b></div>
                        <div style="flex:1;color:#555;max-height:42px;overflow:auto;">
                            ${prod.description || '-'}
                        </div>
                    </div>
                    <div class="info-row">
                        <div><b>How to use:</b></div>
                        <div style="flex:1;color:#555;">${prod.howToUse || '-'}</div>
                    </div>
                `;

                // Dates
                let created = prod.createdAt ? `<span style="color:#999;font-size:90%;">Created: ${new Date(prod.createdAt).toLocaleDateString()}</span>` : '';
                let updated = prod.updatedAt && prod.updatedAt !== prod.createdAt ? `<span style="color:#999;font-size:90%;">Updated: ${new Date(prod.updatedAt).toLocaleDateString()}</span>` : '';
                let dateHtml = created || updated ? `<div style="margin:3px 0 0 0;">${created}${created && updated ? " • " : ""}${updated}</div>` : "";

                // Build Card
                const card = document.createElement("div");
                card.className = "product-card";
                card.style.display = "flex";
                card.style.flexDirection = "column";
                card.innerHTML = `
                    <div style="display:flex;gap:16px;">
                        ${imageSection}
                        <div style="flex:1 1 0;min-width:0;">
                            <div class="product-card-title" style="font-size:120%;font-weight:700;line-height:1;margin-bottom:3px;">${prod.title || '(No Title)'}</div>
                            <div class="product-card__cat" style="color:#8f6ec4;font-size:93%;">${catChain}</div>
                            ${dateHtml}
                        </div>
                    </div>
                    <div style="margin-bottom:3px;margin-top:6px;">
                        ${infoGrid}
                        ${variantsHtml}
                        ${beautyTipsHtml}
                        ${tagsHtml}
                        ${ingredientsHtml}
                        ${benefitsHtml}
                        ${seoHtml}
                        ${descHtml}
                    </div>
                    <div class="product-card-actions" style="margin-top:6px;display:flex;gap:10px;flex-wrap:wrap;">
                        <button class="action-button edit-button" data-id="${prod._id}" onclick="editProduct('${prod._id}')">Edit</button>
                        <button class="action-button secondary-button" data-id="${prod._id}" onclick="toggleProductStatus('${prod._id}')">${prod.status === 'active' ? 'Disable' : 'Enable'}</button>
                        <button class="action-button delete-button" data-id="${prod._id}" onclick="deleteProduct('${prod._id}')">Delete</button>
                    </div>
                `;
                grid.appendChild(card);
            });
        }).catch(err => {
            grid.innerHTML = `<div style="text-align:center;padding:42px 0;color:#c00;font-size:110%;">Failed to load: ${err}</div>`;
        });
    }
    async function fetchProductList() {
        let params = [];
        if (filterVals.category) params.push("category=" + encodeURIComponent(filterVals.category));
        if (filterVals.subCategory) params.push("subCategory=" + encodeURIComponent(filterVals.subCategory));
        if (filterVals.childCategory) params.push("childCategory=" + encodeURIComponent(filterVals.childCategory));
        const url = '/reseller/products' + (params.length ? '?' + params.join('&') : '');
        const res = await fetch(url);
        return await res.json();
    }

    // CRUD
    function showProductModal(isEdit = false, product = null) {
        resetProductForm();
        document.getElementById("product-modal-title").innerText = isEdit ? "Edit Product" : "Add Product";
        document.getElementById("product-modal").style.display = "flex";
        document.getElementById("product-modal").classList.add("active");
        if(isEdit && product) populateProductForm(product);
    }
    function closeProductModal() {
        document.getElementById("product-modal").style.display = "none";
        document.getElementById("product-modal").classList.remove("active");
        resetProductForm();
    }

    async function editProduct(id) {
        try {
            const res = await fetch(`/reseller/products/${id}/one`, { method: 'GET' });
            const data = await res.json();
            if (!data.success) throw data.error || "Product Load Error";
            showProductModal(true, data.product);
        } catch(err) {
            swalAlert("Could not load product: " + err, "error");
        }
    }

    async function toggleProductStatus(id) {
        const result = await swalConfirm("Change product status?");
        if (!result.isConfirmed) return;
        try {
            const res = await fetch(`/reseller/products/${id}/toggle`, { method: 'POST' });
            const data = await res.json();
            if (!data.success) throw data.error;
            loadProductList();
        } catch(err) {
            swalAlert("Could not set status: " + err, "error");
        }
    }
    async function deleteProduct(id) {
        const result = await swalConfirm("Delete this product permanently?");
        if (!result.isConfirmed) return;
        try {
            const res = await fetch(`/reseller/products/delete/${id}`, { method: 'DELETE' });
            const data = await res.json();
            if (!data.success) throw data.error;
            loadProductList();
        } catch(err) {
            swalAlert("Failed to delete: " + err, "error");
        }
    }
    function populateProductForm(product) {
        document.getElementById("product-id").value = product._id || '';
        document.getElementById("title").value = product.title || '';
        document.getElementById("brand").value = product.brand || '';
        document.getElementById("shortDescription").value = product.shortDescription || '';
        document.getElementById("description").value = product.description || '';
        document.getElementById("basePrice").value = product.basePrice || '';
        document.getElementById("salePrice").value = product.salePrice || '';
        document.getElementById("totalStock").value = product.totalStock || '';
        document.getElementById("howToUse").value = product.howToUse || '';
        document.getElementById("weight").value = product.weight || '';
        document.getElementById("dimensions").value = Array.isArray(product.dimensions) ? product.dimensions.join(",") : (product.dimensions || '');

        // Category selection
        document.getElementById("category").value = product.category || '';
        const subSel = document.getElementById("subCategory");
        const childSel = document.getElementById("childCategory");
        subSel.innerHTML = "<option value=''>Select</option>";
        childSel.innerHTML = "<option value=''>Select</option>";
        if (product.category) {
            const subs = getSubcategories(product.category);
            subs.forEach(sc => {
                subSel.innerHTML += `<option value="${sc._id}"${sc._id === product.subCategory ? ' selected' : ''}>${sc.name}</option>`;
            });
            subSel.disabled = false;
            if (product.subCategory) {
                const children = getChildCategories(product.subCategory, product.category);
                children.forEach(ch => {
                    childSel.innerHTML += `<option value="${ch._id}"${ch._id === product.childCategory ? ' selected' : ''}>${ch.name}</option>`;
                });
                childSel.disabled = false;
            }
        }

        // Images
        mainImages = (product.images || []).map(url => typeof url === 'string' ? { url: url, file: null } : { url: url.url, file: null });
        renderMainImages();

        // Pills
        function reapplyPills(arr, getter, wrapperId) {
            if (Array.isArray(arr)) {
                const items = getter();
                items.length = 0;
                items.push(...arr);
                const wrap = document.getElementById(wrapperId);
                wrap.innerHTML = "";
                arr.forEach((txt, idx) => {
                    const pill = document.createElement("div");
                    pill.className = "pill";
                    pill.innerHTML = `${txt} <span class="pill-remove" style='user-select:none;'>×</span>`;
                    pill.querySelector(".pill-remove").onclick = () => {
                        items.splice(idx, 1);
                        wrap.innerHTML = "";
                        items.forEach((txt, idx) => {
                            const newPill = document.createElement("div");
                            newPill.className = "pill";
                            newPill.innerHTML = `${txt} <span class="pill-remove" style='user-select:none;'>×</span>`;
                            wrap.appendChild(newPill);
                        });
                    };
                    wrap.appendChild(pill);
                });
            }
        }
        reapplyPills(product.tags || [], getTags, "tags-wrapper");
        reapplyPills(product.ingredients || [], getIngredients, "ingredients-wrapper");
        reapplyPills(product.benefits || [], getBenefits, "benefits-wrapper");
        reapplyPills((product.seo && product.seo.keywords) || [], getSeoKeywords, "seo-keywords-wrapper");

        // Beauty Tips
        beautyTipsSelected = [];
        Array.from(document.querySelectorAll('.beauty-tip-checkbox')).forEach(cb => cb.checked = false);
        if (Array.isArray(product.beautyTips)) {
            (product.beautyTips || []).forEach(txt => {
                if (
                    txt &&
                    typeof txt === "string" &&
                    txt.trim().length &&
                    !beautyTipsSelected.includes(txt.trim())
                ) {
                    beautyTipsSelected.push(txt.trim());
                }
            });
            Array.from(document.querySelectorAll('.beauty-tip-checkbox')).forEach(cb => {
                if (
                    product.beautyTips &&
                    product.beautyTips
                        .map(v => (typeof v === 'string' ? v.trim() : v))
                        .includes((cb.value || '').trim())
                ) {
                    cb.checked = true;
                }
            });
        }
        renderBeautyTipSelection();
        document.getElementById("seo-title").value = (product.seo && product.seo.title) || '';
        document.getElementById("seo-description").value = (product.seo && product.seo.description) || '';
        // Variants
        variants = Array.isArray(product.variants) ?
            product.variants.map(v => ({
                id: v.id || Date.now() + Math.floor(Math.random() * 1000),
                name: v.name || '',
                options: Array.isArray(v.options) ? v.options.map(o => ({
                    id: o.id || Date.now() + Math.floor(Math.random() * 1000),
                    value: o.value || '',
                    stock: o.stock || 0,
                    price: o.price || 0
                })) : []
            })) : [];
        // show variant images preview too while editing
        if (Array.isArray(product.variants)) {
            variantImagesMap = {};
            product.variants.forEach((v, vi) => {
                const vid = v.id || v._id;
                if (!variantImagesMap[vid]) variantImagesMap[vid] = {};
                if (Array.isArray(v.options)) {
                    v.options.forEach((o, oi) => {
                        const oid = o.id || o._id;
                        if (!variantImagesMap[vid][oid]) variantImagesMap[vid][oid] = [];
                        // show uploaded variant image preview
                        if (Array.isArray(o.images)) {
                            variantImagesMap[vid][oid] = o.images.map(x =>
                                typeof x === "string"
                                    ? { file: null, url: x }
                                    : { file: null, url: x.url }
                            );
                        }
                    });
                }
            });
        }
        renderVariants();
    }
    function resetProductForm() {
        document.getElementById("product-form").reset();
        mainImages = [];
        variants = [];
        variantImagesMap = {};
        renderMainImages();
        renderVariants();
        ["tags-wrapper", "ingredients-wrapper", "benefits-wrapper", "seo-keywords-wrapper", "beauty-tips-wrapper"].forEach(function(wid) {
            document.getElementById(wid).innerHTML = "";
        });
        Array.from(document.querySelectorAll('.beauty-tip-checkbox')).forEach(cb => cb.checked = false);
        beautyTipsSelected = [];
        renderBeautyTipSelection();
        document.getElementById('subCategory').disabled = true;
        document.getElementById('childCategory').disabled = true;
        // Remove loading/progress from save button
        let btn = document.getElementById("save-product-btn");
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = "Save Product";
        }
    }
})();
</script>

<style>
.product-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(330px, 1fr));
    gap: 26px 23px;
    margin: 18px;
    margin-top: 0;
}
.product-card {
    background: linear-gradient(120deg,#fff,#f1eafd 88%);
    border-radius: 20px;
    box-shadow: 0 7px 33px 0 #f3d7f91f, 0 1px 3px #ddd;
    padding: 36px 24px 18px 24px;
    display: flex;
    flex-direction: column;
    position: relative;
    transition: box-shadow .24s cubic-bezier(.6,.5,.22,.97);
    border: 1.5px solid #ebd5ff;
    min-height: 300px;
}
.product-card:hover {
    box-shadow: 0 8px 38px #efd4fa46, 0 1.5px 9px #d0f;
    border-color: #ba86e9;
}
.product-card-image {
    width: 86px;
    height: 86px;
    object-fit: cover;
    border-radius: 13px;
    border:2.5px solid #e3d0f5;
    margin-right: 20px;
    background: linear-gradient(120deg,#ede7f6, #ffecfa);
    box-shadow: 0 1px 6px #ecd1ed38;
}
.product-card-top {
    display: flex;
    align-items: flex-start;
    gap: 19px;
    margin-bottom: 12px;
}
.product-card-title {
    font-size: 1.15rem;
    font-weight: 700;
    color: #7b1fa2;
    margin-bottom: 2px;
}
.product-card__cat, .product-card__id {
    font-size: .92em;
    color: #9575cd;
    margin-bottom: 2px;
}
.product-card .pill {
    font-size: 90%;background:#e1bee7;color:#891b98;padding:4px 9px;margin-right:4px;margin-bottom:2px;
}
.product-card-details {
    margin-top:2px;
    margin-bottom:10px;
    display:grid;
    grid-template-columns: 1fr 1fr;
    gap:5px 14px;
    font-size: 95%;
}
.product-card-actions {
    display: flex;
    gap: 10px;
    margin-top:14px;
}
.product-card-actions button {
    border-radius:18px;
    padding: 5px 18px 6px 18px;
    font-weight: 500;
    border: none;
    cursor: pointer;
    color: #fff;
    transition:.17s;
}
.product-card-actions .edit-button {background: #7e57c2;}
.product-card-actions .secondary-button {background: #cfd8dc;color:#6a2b6e;}
.product-card-actions .delete-button {background: #e57373;}
.status-badge {
    display: inline-block;
    border-radius: 12px;
    font-size: 92%;
    padding: 2px 11px;
    background: #f0e1ff;
    color: #7e57c2;
    font-weight: 600;
}
.status-badge.status-confirmed {background:#c6e1e7;color:#388e3c;}
.status-badge.status-pending {background:#ffe0b2;color:#ff7043;}
.images-wrapper{display:flex;flex-wrap:wrap;gap:10px}
.image-box{width:90px;height:90px;border:1px solid #ccc;border-radius:6px;overflow:hidden;position:relative}
.image-box img{width:100%;height:100%;object-fit:cover}
.image-actions{position:absolute;bottom:3px;right:3px;display:flex;gap:4px}
.image-actions button{background:rgba(0,0,0,0.7);color:white;border:none;padding:2px 5px;font-size:10px;border-radius:3px}

.pill-box{display:flex;gap:8px;flex-wrap:wrap}
.pill{background:#e5e5e5;padding:5px 10px;border-radius:20px;display:flex;gap:5px;align-items:center}
.pill-remove{cursor:pointer;font-size:12px;color:red;font-weight:bold}

.variant-box{border:1.5px solid #ba68c8;padding:17px 16px 19px 16px;border-radius:8px;margin-bottom:14px;background:#f6f1fd}
.option-box{border:1px solid #ccc;padding:10px 10px 12px 10px;border-radius:6px;margin-top:12px;display:grid;grid-template-columns:repeat(3,1fr);gap:10px 18px;align-items:end}

.option-label{font-size:88%;color:#8051c7;margin-bottom:3px;display:block}

.modal-overlay {
    z-index: 9999;
}
.modal {
    z-index: 10000;
}
.modal-overlay {
    display: none;
    position: fixed;
    left: 0; top: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.38);
    align-items: center;
    justify-content: center;
}
.modal-overlay.active,
.modal-overlay[style*="display: flex"] {
    display: flex !important;
}
#product-modal input:focus, #product-modal textarea:focus, #product-modal select:focus {
    border-color:#ba68c8 !important; box-shadow:0 1px 11px #f3e1f8a6 !important;
}
#product-modal .form-input, #product-modal .form-select, #product-modal textarea {
    border-radius: 8px;
    border:1.5px solid #e1bee7;
    transition: .1s border;
}
</style>
            <!-- Orders Page -->
            <div class="page-content" id="orders-page">
                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Order Management</h3>
                        <button class="action-button edit-button" disabled>Export Orders</button>
                    </div>
                    <div style="text-align: center; padding: 48px 0; color: #888; font-size: 1.2em;">
                        No orders found
                    </div>
                </div>
            </div>

            <!-- Account Page -->
            <div class="page-content" id="account-page">
                <div class="dashboard-sections">
                    <div class="section-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="<%= resellers && resellers[0] && resellers[0].contactName ? resellers[0].contactName : 'Reseller' %>">
                            </div>
                            <div class="profile-info">
                                <h3>
                                    <%= resellers && resellers[0] && resellers[0].contactName ? resellers[0].contactName : (resellers && resellers[0] && resellers[0].companyName ? resellers[0].companyName : 'Reseller') %>
                                </h3>
                                <p>
                                    <%= resellers && resellers[0] && resellers[0].businessDescription ? resellers[0].businessDescription : (resellers && resellers[0] && resellers[0].companyName ? resellers[0].companyName : '') %>
                                </p>
                                <p>
                                    Member since <%= resellers && resellers[0] && resellers[0].createdAt ? new Date(resellers[0].createdAt).toLocaleString('en-IN', { month: 'long', year: 'numeric' }) : '-' %>
                                </p>
                                <!-- Optional: add custom statistics cards if any new relevant fields-->
                                <div class="profile-stats">
                                    <div class="profile-stat">
                                        <div class="stat-value">
                                            ₹<%= (resellers && resellers[0] && typeof resellers[0].totalEarnings !== "undefined") ? resellers[0].totalEarnings.toLocaleString("en-IN") : "0" %>
                                        </div>
                                        <div class="stat-label">Total Revenue</div>
                                    </div>
                                    <div class="profile-stat">
                                        <div class="stat-value">
                                            <%= (resellers && resellers[0] && typeof resellers[0].totalOrders !== "undefined") ? resellers[0].totalOrders : 0 %>
                                        </div>
                                        <div class="stat-label">Total Orders</div>
                                    </div>
                                    <div class="profile-stat">
                                        <div class="stat-value">
                                            <%= (resellers && resellers[0] && typeof resellers[0].totalSales !== "undefined") ? resellers[0].totalSales : 0 %>
                                        </div>
                                        <div class="stat-label">Total Products</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="section-header">
                            <h3 class="section-title">Account Information</h3>
                            <button class="action-button edit-btn" id="edit-account-btn">Edit Account</button>
                        </div>
                        <% if (resellers && resellers[0]) { %>
                        <div class="profile-details">
                            <div class="profile-field">
                                <span class="field-label">Business Name</span>
                                <span class="field-value" id="store-name"><%= resellers[0].companyName %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">GST No.</span>
                                <span class="field-value" id="gst-number"><%= resellers[0].gstNo || "—" %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Contact Name</span>
                                <span class="field-value" id="owner-name"><%= resellers[0].contactName %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Email</span>
                                <span class="field-value" id="email-address"><%= resellers[0].email %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Phone</span>
                                <span class="field-value" id="phone-number"><%= resellers[0].phone %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Business Description</span>
                                <span class="field-value" id="business-description"><%= resellers[0].businessDescription || '-' %></span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Status</span>
                                <span class="field-value">
                                    <% if (resellers[0].status === "approved") { %>
                                        <span class="status-badge status-confirmed">Approved</span>
                                    <% } else if (resellers[0].status === "pending") { %>
                                        <span class="status-badge status-pending">Pending</span>
                                    <% } else if (resellers[0].status === "rejected") { %>
                                        <span class="status-badge status-cancelled">Rejected</span>
                                    <% } else { %>
                                        <span class="status-badge status-secondary"><%= resellers[0].status %></span>
                                    <% } %>
                                </span>
                            </div>
                            <% if (resellers[0].status === "rejected" && resellers[0].rejectionReason) { %>
                            <div class="profile-field">
                                <span class="field-label">Rejection Reason</span>
                                <span class="field-value"><%= resellers[0].rejectionReason %></span>
                            </div>
                            <% } %>
                            <div class="profile-field">
                                <span class="field-label">Member Since</span>
                                <span class="field-value" id="member-since">
                                    <%= resellers[0].createdAt ? new Date(resellers[0].createdAt).toLocaleString('en-IN', { month: 'long', year: 'numeric' }) : '-' %>
                                </span>
                            </div>
                        </div>
                        <% } else { %>
                            <div style="color: #888; margin:1em;">No account information available.</div>
                        <% } %>
                        <div class="profile-actions" id="profile-actions" style="display: none;">
                            <button class="cancel-btn" id="cancel-account-btn">Cancel</button>
                            <button class="save-btn" id="save-account-btn">Save Changes</button>
                        </div>
                    </div>

                    <div class="section-card">
                        <div class="section-header">
                            <h3 class="section-title">More Account Details</h3>
                        </div>
                        <% if (resellers && resellers[0]) { %>
                        <div class="profile-details">
                            <div class="profile-field">
                                <span class="field-label">Total Products</span>
                                <span class="field-value">
                                    <%= typeof resellers[0].totalSales !== "undefined" ? resellers[0].totalSales : 0 %>
                                </span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Total Orders</span>
                                <span class="field-value">
                                    <%= typeof resellers[0].totalOrders !== "undefined" ? resellers[0].totalOrders : 0 %>
                                </span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Total Revenue</span>
                                <span class="field-value">
                                    ₹<%= typeof resellers[0].totalEarnings !== "undefined" ? resellers[0].totalEarnings.toLocaleString("en-IN") : "0" %>
                                </span>
                            </div>
                            <div class="profile-field">
                                <span class="field-label">Warehouses</span>
                                <span class="field-value">
                                    <%= Array.isArray(resellers[0].warehouses) ? resellers[0].warehouses.length : 0 %>
                                </span>
                            </div>
                            <% if (Array.isArray(resellers[0].warehouses) && resellers[0].warehouses.length > 0) { %>
                            <div class="profile-field" style="flex-direction:column;align-items: flex-start;">
                                <span class="field-label">Warehouse List:</span>
                                <ul style="padding-left: 1.2em; margin: 0;">
                                    <% resellers[0].warehouses.forEach(function(wh, idx) { %>
                                        <li>
                                            <b><%= wh.name %></b>
                                            <span style="color: #888;">
                                                (<%= wh.city || '-' %>, <%= wh.state || '-' %>)
                                                <% if (wh.isDefault) { %> - <span class="status-badge status-confirmed">Default</span><% } %>
                                            </span><br>
                                            <span style="font-size:90%; color:#666;"><%= wh.address || '' %><% if(wh.pincode){ %>, <%= wh.pincode %><% } %></span>
                                            <% if (wh.phone) { %>
                                                <span style="font-size:90%;"> | 📞 <%= wh.phone %></span>
                                            <% } %>
                                            <% if (wh.googleMapLink) { %>
                                                <span style="font-size:90%;"> | <a href="<%= wh.googleMapLink %>" target="_blank">Google Map</a></span>
                                            <% } %>
                                        </li>
                                    <% }) %>
                                </ul>
                            </div>
                            <% } %>

                            <div class="profile-field">
                                <span class="field-label">Documents</span>
                                <span class="field-value">
                                    <% if (Array.isArray(resellers[0].documents) && resellers[0].documents.length > 0) { %>
                                        <ul style="padding-left:1.2em;margin:0;">
                                            <% resellers[0].documents.forEach(function(doc) { %>
                                                <li>
                                                    <a href="<%= doc.url %>" target="_blank"><%= doc.name %></a>
                                                    (<%= doc.uploadedAt ? new Date(doc.uploadedAt).toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) : '' %>)
                                                </li>
                                            <% }) %>
                                        </ul>
                                    <% } else { %>
                                        <span style="color: #aaa;">No documents uploaded</span>
                                    <% } %>
                                </span>
                            </div>
                            <% if (resellers[0].verifiedByAdmin) { %>
                            <div class="profile-field">
                                <span class="field-label">Verified By Admin</span>
                                <span class="field-value">
                                    <%= resellers[0].verifiedByAdmin %>
                                    <% if (resellers[0].verifiedAt) { %>
                                        (on <%= new Date(resellers[0].verifiedAt).toLocaleString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' }) %>)
                                    <% } %>
                                </span>
                            </div>
                            <% } %>
                        </div>
                        <% } else { %>
                            <div style="color: #888; margin:1em;">No additional account details available.</div>
                        <% } %>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Product Modal -->
   

    <!-- Order Status Modal -->
    <div class="modal-overlay" id="order-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Update Order Status</h3>
                <button class="modal-close" id="close-order-modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="order-form">
                    <input type="hidden" id="order-id">
                    <div class="form-group">
                        <label class="form-label" for="order-status">Order Status</label>
                        <select class="form-select" id="order-status">
                            <option value="pending">Pending</option>
                            <option value="confirmed">Confirmed</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="order-notes">Notes (Optional)</label>
                        <textarea class="form-input form-textarea" id="order-notes" placeholder="Add any notes about this order status update"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="action-button secondary-button" id="cancel-order-btn">Cancel</button>
                <button class="action-button confirm-button" id="save-order-btn">Update Status</button>
            </div>
        </div>
    </div>

    <!-- Order Details Modal -->
    <div class="modal-overlay" id="order-details-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Order Details - <span id="order-details-id"></span></h3>
                <button class="modal-close" id="close-order-details-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-details-container">
                    <div class="client-info-section">
                        <h4 class="section-subtitle">Client Information</h4>
                        <div class="client-details">
                            <div class="client-field">
                                <span class="field-name">Full Name:</span>
                                <span class="field-value" id="client-name">Emma Johnson</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Email:</span>
                                <span class="field-value" id="client-email">emma.johnson@example.com</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Phone:</span>
                                <span class="field-value" id="client-phone">+91 98765 43210</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Address:</span>
                                <span class="field-value" id="client-address">123 Main Street, Apartment 4B, Mumbai, 400001</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Order Date:</span>
                                <span class="field-value" id="order-date">October 15, 2023</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Order Status:</span>
                                <span class="field-value"><span class="status-badge status-pending">Pending</span></span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Payment Method:</span>
                                <span class="field-value" id="payment-method">UPI</span>
                            </div>
                            <div class="client-field">
                                <span class="field-name">Payment Status:</span>
                                <span class="field-value"><span class="status-badge status-confirmed">Paid</span></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="order-items-section">
                        <h4 class="section-subtitle">Ordered Products</h4>
                        <div class="order-items">
                            <div class="order-item">
                                <div class="item-image">
                                    <img src="https://via.placeholder.com/60" alt="Vitamin C Serum">
                                </div>
                                <div class="item-details">
                                    <div class="item-name">Vitamin C Serum</div>
                                    <div class="item-category">Skincare</div>
                                    <div class="item-price">₹1,299</div>
                                </div>
                                <div class="item-quantity">
                                    <span class="quantity-badge">1</span>
                                </div>
                            </div>
                            <div class="order-item">
                                <div class="item-image">
                                    <img src="https://via.placeholder.com/60" alt="Matte Lipstick">
                                </div>
                                <div class="item-details">
                                    <div class="item-name">Matte Lipstick - Ruby</div>
                                    <div class="item-category">Makeup</div>
                                    <div class="item-price">₹599</div>
                                </div>
                                <div class="item-quantity">
                                    <span class="quantity-badge">2</span>
                                </div>
                            </div>
                            <div class="order-item">
                                <div class="item-image">
                                    <img src="https://via.placeholder.com/60" alt="Hair Growth Oil">
                                </div>
                                <div class="item-details">
                                    <div class="item-name">Hair Growth Oil</div>
                                    <div class="item-category">Haircare</div>
                                    <div class="item-price">₹899</div>
                                </div>
                                <div class="item-quantity">
                                    <span class="quantity-badge">1</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="order-summary">
                            <div class="summary-row">
                                <span>Subtotal:</span>
                                <span>₹3,396</span>
                            </div>
                            <div class="summary-row">
                                <span>Shipping:</span>
                                <span>₹50</span>
                            </div>
                            <div class="summary-row">
                                <span>Tax (5%):</span>
                                <span>₹169.80</span>
                            </div>
                            <div class="summary-row summary-total">
                                <span>Total:</span>
                                <span>₹3,615.80</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="action-button secondary-button" id="close-order-details-btn">Close</button>
                <button class="action-button edit-button">Print Invoice</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Mobile menu toggle
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const sidebarNavigation = document.getElementById('sidebarNavigation');
            const mainContentArea = document.getElementById('mainContentArea');
            
            mobileMenuToggle.addEventListener('click', function() {
                sidebarNavigation.classList.toggle('mobile-hidden');
                mainContentArea.classList.toggle('full-width');
                
                // Change icon based on menu state
                const icon = this.querySelector('i');
                if (sidebarNavigation.classList.contains('mobile-hidden')) {
                    icon.className = 'fas fa-bars';
                } else {
                    icon.className = 'fas fa-times';
                }
            });
            
            // Page Navigation
            const navItems = document.querySelectorAll('.nav-item');
            const pageContents = document.querySelectorAll('.page-content');
            const pageTitle = document.getElementById('current-page-title');
            const pageDescription = document.getElementById('current-page-description');
            
            // Page titles and descriptions
            const pageData = {
                'dashboard': {
                    title: 'Retailer Dashboard',
                    description: 'Welcome back, Sarah! Here\'s your beauty products business overview.'
                },
                'categories': {
                    title: 'Category Management',
                    description: 'Manage your product categories and organization.'
                },
                'products': {
                    title: 'Product Management',
                    description: 'Add, edit, and manage your beauty products.'
                },
                'orders': {
                    title: 'Order Management',
                    description: 'View and manage customer orders and status.'
                },
                'account': {
                    title: 'Account Details',
                    description: 'Manage your retailer account and store information.'
                }
            };
            
            // Navigation click handler
            navItems.forEach(item => {
                item.addEventListener('click', function() {
                    const pageId = this.getAttribute('data-page');
                    
                    // Update active nav item
                    navItems.forEach(i => i.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Show selected page
                    pageContents.forEach(page => page.classList.remove('active'));
                    document.getElementById(`${pageId}-page`).classList.add('active');
                    
                    // Update page title and description
                    pageTitle.textContent = pageData[pageId].title;
                    pageDescription.textContent = pageData[pageId].description;
                    
                    // Close mobile menu on navigation
                    if (window.innerWidth <= 992) {
                        sidebarNavigation.classList.add('mobile-hidden');
                        mainContentArea.classList.add('full-width');
                        mobileMenuToggle.querySelector('i').className = 'fas fa-bars';
                    }
                });
            });
            
           
            // Helper function to exit edit mode
            function exitEditMode() {
                profileFields.forEach(field => {
                    field.classList.remove('editing');
                });
                
                // Hide save/cancel buttons
                profileActions.style.display = 'none';
                // Show edit button
                editAccountBtn.style.display = 'block';
            }
        });
    </script>
</body>
</html>